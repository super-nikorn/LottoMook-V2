<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ระบบจัดเรียงโพยหวย</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link rel="icon" href="assets/image/lotto.ico" type="image/x-icon" />
    <link rel="stylesheet" href="./assets/css/style.css" />
    <style>
      body {
        background-color: #f8fafc;
      }
      .lotto-card {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
    </style>
  </head>

  <body class="min-h-screen bg-gray-50 py-8 px-4">
    <div id="nav-placeholder"></div>
    <!-- <div id="dialog-placeholder"></div> -->
    <div id="lotto-placeholder"></div>
    <div class="max-w-3xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-red-600 mb-2 mt-6">
          ระบบจัดเรียงโพยหวย
        </h1>
        <p class="text-gray-600">กรอกข้อมูลโพยหวยเพื่อจัดเรียงและคำนวณยอดรวม</p>
      </div>

      <!-- Input Section -->
      <div class="bg-white rounded-lg lotto-card p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">กรอกโพยหวย</h2>

        <div class="mb-4">
          <h3 class="text-lg font-medium text-gray-700 mb-2">ข้อมูลผู้ซื้อ:</h3>
          <input
            type="text"
            id="buyerName"
            placeholder="กรอกชื่อผู้ซื้อ"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
          />
        </div>

        <div class="mb-4">
          <label
            for="lottoInput"
            class="block text-lg font-medium text-gray-700 mb-2"
            >รายการหวย:</label
          >
          <textarea
            id="lottoInput"
            rows="10"
            placeholder="ตัวอย่าง : การกรอกโพยหวย&#10;139 = 3 ตัวตรง-โต๊ด&#10;439 = 3 ตัวตรง-โต๊ด&#10;85 = 2 ตัว บน-ล่าง&#10;49 = 2 ตัว บน-ล่าง&#10;50*50 = ระบบจะกลับเลขอัตโนมัติ"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 font-mono"
          ></textarea>
        </div>

        <div class="flex space-x-3">
          <button
            onclick="handleProcess()"
            class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors"
          >
            จัดเรียงโพย
          </button>
          <button
            onclick="clearForm()"
            class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors"
          >
            ล้างฟอร์ม
          </button>
        </div>
      </div>

      <!-- Choice Box (Hidden by default) -->
      <div
        id="choiceBox"
        class="bg-white rounded-lg lotto-card p-6 mb-6 hidden"
      >
        <p id="choicePrompt" class="text-lg font-medium text-gray-700 mb-4">
          เลือกประเภท:
        </p>
        <div id="radioContainer" class="mb-4"></div>
        <button
          onclick="submitChoice()"
          class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors"
        >
          ยืนยัน
        </button>
      </div>

      <!-- Output Section -->
      <div class="bg-white rounded-lg lotto-card p-6 mb-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
          โพยจัดเรียงแล้ว:
        </h3>
        <textarea
          id="outputResult"
          rows="10"
          readonly
          class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 font-mono"
        ></textarea>

        <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-2">
          สรุปยอดรวม:
        </h3>
        <div
          id="totalAmount"
          class="text-2xl font-bold text-red-600 py-2 px-4 bg-gray-100 rounded-md inline-block"
        >
          - บาท
        </div>

        <div class="mt-6">
          <button
            onclick="handleSaveClick()"
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
          >
            บันทึกโพย
          </button>
        </div>
      </div>
    </div>

    <script>
      let tempParsed = null;
      let tempParsedType = null;
      let tempResultLines = [];
      let tempTickets = [];

      function preprocessInput(inputText) {
        document.getElementById("lottoInput").addEventListener("input", () => {
          document.getElementById("choiceBox").style.display = "none";
          document.getElementById("radioContainer").innerHTML = "";
          document.getElementById("choicePrompt").textContent = "";
          tempParsed = null;
          tempParsedType = null;
        });

        inputText = inputText
          .replace(/\r/g, "")
          .split("\n")
          .map((line) => line.trim())
          .filter(Boolean);
        const grouped = [];
        let buffer = [];

        inputText.forEach((line) => {
          if (/^\d{1,3}$/.test(line)) {
            buffer.push(line);
          } else if (/^\d+(?:\*\d+)?$/.test(line) && buffer.length > 0) {
            // จับคู่ทุกตัวใน buffer กับเงิน
            buffer.forEach((num) => {
              grouped.push(`${num} ${line}`);
            });
            buffer = [];
          } else if (/^\d{1,3}\s+\d+(?:\*\d+)?$/.test(line)) {
            grouped.push(line); // รูปแบบสมบูรณ์
          } else {
            grouped.push(`INVALID ${line}`); // รูปแบบผิด
          }
        });

        // ถ้า buffer ค้างอยู่ แสดงว่าไม่มีจำนวนเงินตามมา
        buffer.forEach((num) => {
          grouped.push(`INVALID ${num}`);
        });

        return grouped;
      }

      function parseTicket(ticketStr) {
        const regex = /^(\d{1,3})\s+(\d+)(?:\*(\d+))?$/;
        const match = ticketStr.match(regex);
        if (!match) return { error: `รูปแบบไม่ถูกต้อง: "${ticketStr}"` };
        return {
          number: match[1],
          money1: parseInt(match[2]),
          money2: match[3] ? parseInt(match[3]) : null,
        };
      }

      function classifyTicket({ number, money1, money2 }) {
        const lines = [];
        if (number.length === 3) {
          if (money2 === null) {
            tempParsed = { number, money1 };
            tempParsedType = "สามตัว";
            return "WAIT_USER_CHOICE";
          }
          lines.push(`สามตัวตรง ${number} = ${money1} บาท`);
          lines.push(`สามตัวโต๊ด ${number} = ${money2} บาท`);
        } else if (number.length === 2) {
          if (money2 === null) {
            tempParsed = { number, money1 };
            tempParsedType = "บนล่าง";
            return "WAIT_USER_CHOICE";
          }
          lines.push(`บน ${number} = ${money1} บาท`);
          lines.push(`ล่าง ${number} = ${money2} บาท`);
        } else {
          lines.push(`เลข "${number}" ไม่ถูกต้อง`);
        }
        return lines;
      }

      function handleProcess() {
        const inputText = document.getElementById("lottoInput").value;
        tempTickets = preprocessInput(inputText);
        tempResultLines = [];
        processNextTicket();
      }

      function processNextTicket() {
        if (tempTickets.length === 0) {
          document.getElementById("outputResult").value =
            tempResultLines.join("\n");

          const total = calculateTotal(tempResultLines);
          document.getElementById("totalAmount").textContent = total + " บาท";
          return;
        }

        const ticket = tempTickets.shift();
        if (ticket.startsWith("INVALID")) {
          tempResultLines.push(
            `รูปแบบไม่ถูกต้อง: "${ticket.replace("INVALID ", "")}"`
          );
          processNextTicket();
          return;
        }

        const parsed = parseTicket(ticket);
        if (parsed.error) {
          tempResultLines.push(parsed.error);
          processNextTicket();
          return;
        }

        const result = classifyTicket(parsed);
        if (result === "WAIT_USER_CHOICE") {
          setupChoiceBox(parsed);
        } else {
          tempResultLines.push(...result);
          processNextTicket();
        }
      }

      function setupChoiceBox(parsed) {
        let msg = "";
        let options = [];

        if (tempParsedType === "บนล่าง") {
          msg = `ระบุว่า "${parsed.number}" ${parsed.money1} บาท เป็น "บน" หรือ "ล่าง"?`;
          options = ["บน", "ล่าง"];
        } else if (tempParsedType === "สามตัว") {
          msg = `ระบุว่า "${parsed.number}" ${parsed.money1} บาท เป็น "สามตัวตรง" หรือ "สามตัวโต๊ด"?`;
          options = ["สามตัวตรง", "สามตัวโต๊ด"];
        }

        document.getElementById("choicePrompt").textContent = msg;
        const container = document.getElementById("radioContainer");
        container.innerHTML = "";
        options.forEach((opt) => {
          const label = document.createElement("label");
          const radio = document.createElement("input");
          radio.type = "radio";
          radio.name = "typeChoice";
          radio.value = opt;
          label.appendChild(radio);
          label.appendChild(document.createTextNode(" " + opt));
          container.appendChild(label);
        });

        document.getElementById("choiceBox").style.display = "block";
      }

      function submitChoice() {
        const choice = document.querySelector(
          'input[name="typeChoice"]:checked'
        );
        if (!choice) {
          alert("กรุณาเลือกตัวเลือกก่อน");
          return;
        }

        const type = choice.value;
        const { number, money1 } = tempParsed;

        if (tempParsedType === "บนล่าง") {
          tempResultLines.push(`${type} ${number} = ${money1} บาท`);
        } else if (tempParsedType === "สามตัว") {
          tempResultLines.push(`${type} ${number} = ${money1} บาท`);
        }

        tempParsed = null;
        tempParsedType = null;
        document.getElementById("choiceBox").style.display = "none";
        processNextTicket();
      }

      function clearForm() {
        document.getElementById("lottoInput").value = "";
        document.getElementById("outputResult").value = "";
        document.getElementById("choiceBox").style.display = "none";
        document.getElementById("buyerName").value = "";
        document.getElementById("totalAmount").textContent = "- บาท";
        tempParsed = null;
        tempParsedType = null;
        tempTickets = [];
        tempResultLines = [];
      }

      function calculateTotal(resultLines) {
        let total = 0;
        resultLines.forEach((line) => {
          const match = line.match(/= (\d+) บาท$/);
          if (match) {
            total += parseInt(match[1]);
          }
        });
        return total;
      }
    </script>

    <script type="module">
      import { saveToDatabase } from "./assets/js/scripts/addLotto.js";

      window.handleSaveClick = () => {
        const buyer = document.getElementById("buyerName").value.trim();
        const resultLines = document
          .getElementById("outputResult")
          .value.trim()
          .split("\n");

        if (!buyer || resultLines.length === 0) {
          alert("กรุณากรอกชื่อผู้ซื้อ และโพยก่อนบันทึก");
          return;
        }

        const payload = {
          ชื่อผู้ซื้อ: buyer,
          เวลาที่บันทึก: new Date().toISOString(),
          ยอดรวม: calculateTotal(resultLines),
          ประเภท: {
            บน: [],
            ล่าง: [],
            สามตัวตรง: [],
            สามตัวโต๊ด: [],
          },
        };

        resultLines.forEach((line) => {
          const m = line.match(
            /^(บน|ล่าง|สามตัวตรง|สามตัวโต๊ด) (\d{1,3}) = (\d+) บาท$/
          );
          if (m) {
            const [, type, number, money] = m;
            payload.ประเภท[type].push({
              เลข: parseInt(number),
              เงิน: parseInt(money),
            });
          }
        });

        saveToDatabase(payload);

        // ล้างฟอร์ม
        document.getElementById("buyerName").value = "";
        document.getElementById("lottoInput").value = "";
        document.getElementById("outputResult").value = "";
        document.getElementById("totalAmount").textContent = "- บาท";
      };

      function calculateTotal(lines) {
        return lines.reduce((total, line) => {
          const match = line.match(/= (\d+) บาท$/);
          return total + (match ? parseInt(match[1]) : 0);
        }, 0);
      }
    </script>
    <script type="module" src="./assets/js/main.js"></script>
  </body>
</html>
